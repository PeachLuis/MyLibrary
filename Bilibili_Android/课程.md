## P7 控件基础

2. 约束布局中辅助线的使用
2. button、radioGroup、checkBok等控件的点击事件 。这里使用的都是基本情况，button是点击事件，其他的是选择内容变更做出的动作。

```java
package com.example.biliandroid;

import androidx.appcompat.app.AppCompatActivity;

import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.CheckBox;
import android.widget.CompoundButton;
import android.widget.RadioGroup;
import android.widget.Switch;
import android.widget.TextView;

public class MainActivity extends AppCompatActivity {

    TextView tv1, tv2;
    Button btn;
    Switch aSwitch;
    RadioGroup radioGroup;
    CheckBox checkBox;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        //绑定控件
        tv1 = findViewById(R.id.tv1);
        tv2 = findViewById(R.id.tv2);
        btn = findViewById(R.id.button2);
        aSwitch = findViewById(R.id.switch1);
        radioGroup = findViewById(R.id.radioGroup);
        checkBox = findViewById(R.id.checkBox);

        //普通按钮的点击事件
        btn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                tv1.setText(R.string.btnString);
            }
        });

        //Switch的点击事件
        aSwitch.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {
            @Override
            public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
                if (isChecked) {
                    tv1.setText(R.string.switchON);
                } else {
                    tv1.setText(R.string.switchOFF);
                }
            }
        });

        //radioGroup的点击事件
        radioGroup.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener() {
            @Override
            public void onCheckedChanged(RadioGroup group, int checkedId) {
                if (checkedId == R.id.radioButton1) {
                    tv1.setText(R.string.radioGroupApple);
                } else {
                    tv1.setText(R.string.radioGroupAndroid);
                }

            }
        });

        //checkBox的使用
        checkBox.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {
            @Override
            public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
                tv1.setText(checkBox.getText());
            }
        });
    }
}
```





## P8 本地化及多语言支持

在控件上显示的字符串，建议都使用string.xml存储, 这样更适合国际化编程

添加另外的语言, 只需要在string.xml文件中点击右上角open editer, 然后点击左上方的地球, 添加每一个字符的指定语言值



## P9 屏幕方向旋转

默认情况下，屏幕可以旋转，旋转后，页面会经历OnDestory，所以页面之前的数据会丢失。

可以在AndroidManifest文件中使**指定活动**的屏幕的指定方向，使其无法旋转，如下代码可以使MainActivity始终为竖直方向。

```xml
<activity android:name=".MainActivity"
    android:screenOrientation="portrait">
    <intent-filter>
        <action android:name="android.intent.action.MAIN" />

        <category android:name="android.intent.category.LAUNCHER" />
    </intent-filter>
</activity>
```

但一般情况下，支持旋转屏幕的应用，大部分是为了横竖屏的布局不一样，所以需要设置两个布局，分别对应横竖屏。

![image-20201117094431856](img/image-20201117094431856.png)

在此处选择创建一个水平方向的布局即可，AS会自动创建一个水平方向布局的layout文件，在屏幕旋转到水平时，就会自动使用水平方向的布局文件。

**保存数据：**

这个方法只适用于暂时保存，如果是退出程序，则无法保存

```java
@Override
protected void onSaveInstanceState(@NonNull Bundle outState) {
    super.onSaveInstanceState(outState);
    outState.putString("KEY", tv1.getText().toString());
}

@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    //绑定控件
    tv1 = findViewById(R.id.tv1);
    //这里要放在初始化后面，不然tv1是null
    if (savedInstanceState != null) {
        String s = "";
        s = savedInstanceState.getString("KEY");
        tv1.setText(s);
    }
}
```



## P10 ViewModel（从MVC到MVVM）

![image-20201119135857695](img/image-20201119135857695.png)

ViewModel主要是将数据都存放在ViewModel中，实现data和view的分离，使用ViewModel也可以更简单地解决活动destory后重建导致数据丢失的问题。使用ViewModel存取数据就不用像上节中使用`onSaveInstanceState`方法来保存数据。

ViewModel所在包：androidx.lifecycle.ViewModel

![image-20201119135942620](img/image-20201119135942620.png)

活动经历onDestory场景：

- 屏幕翻转
- 切换到其他app的页面或者主页

一个使用ViewModel的例子：

MainActivity2.java：

```java
public class MainActivity2 extends AppCompatActivity {

    TextView textView;
    Button button;
    MyViewModel viewModel;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main2);
        viewModel = new ViewModelProvider(this,new ViewModelProvider.NewInstanceFactory()).get(MyViewModel.class);

        textView = findViewById(R.id.tv_act2);
        button = findViewById(R.id.btn_act2);

        int temp = viewModel.getValue();
        if (temp != 0) {
            //TextView的setText方法接受int参数是资源id，找不到就会报错
            //所以这里设置数字应该先转为字符串，使用CharSequence为参数的方法
            textView.setText(String.valueOf(temp));
        }

        button.setOnClickListener(v -> {
            viewModel.setValue(viewModel.getValue() + 1);
            textView.setText(String.valueOf(viewModel.getValue()));
        });

    }
}
```

MyViewModel.java：

```java
public class MyViewModel extends ViewModel {

    private int value = 0;

    public int getValue() {
        return value;
    }

    public void setValue(int value) {
        this.value = value;
    }

}
```

activity_main2.xml：

```xml
<androidx.constraintlayout.widget.ConstraintLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context=".MainActivity2">

    <TextView
        android:id="@+id/tv_act2"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="@string/text"
        android:textSize="30sp"
        app:layout_constraintBottom_toBottomOf="parent"
        app:layout_constraintEnd_toEndOf="parent"
        app:layout_constraintHorizontal_bias="0.498"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintTop_toTopOf="parent"
        app:layout_constraintVertical_bias="0.229" />

    <Button
        android:id="@+id/btn_act2"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="@string/btn_act2"
        app:layout_constraintBottom_toBottomOf="parent"
        app:layout_constraintEnd_toEndOf="parent"
        app:layout_constraintHorizontal_bias="0.498"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintTop_toTopOf="parent"
        app:layout_constraintVertical_bias="0.458" />
</androidx.constraintlayout.widget.ConstraintLayout>
```

![image-20201119205441377](img/image-20201119205441377.png)

总结，此种方法在上一种基础上，取消了savedInstance的使用，采取了ViewModel来保存数据，但是这种方法保存的数据只适用于屏幕旋转导致的活动的onDestory，如果是切换到其他App页面或者主页，则仍无法保存，适用savedInstance则都能保存。



## P11 LiveData

LiveData，在底层数据库更改时通知视图

MVC架构，不包含Model：

![image-20201119223147169](img/image-20201119223147169.png)

![image-20201119223232937](img/image-20201119223232937.png)

![image-20201119223302148](img/image-20201119223302148.png)



MyViewModel：

```java
public class MyViewModel extends ViewModel {

    private int value = 0;

    //LiveData的变量
    private MutableLiveData<Integer> thumbNum;

    public MutableLiveData<Integer> getThumbNum() {
        //因为实例域thumbNum是类变量，所以采取懒汉模式进行初始化
        if (thumbNum == null) {
            thumbNum = new MutableLiveData<>();
            thumbNum.setValue(0);
        }
        return thumbNum;
    }

    public void addThumb(int value) {
        thumbNum.setValue(thumbNum.getValue()+value);
    }

    public int getValue() {
        return value;
    }

    public void setValue(int value) {
        this.value = value;
    }

}
```

LiveDataTest.java：

```java
public class LiveDataTest extends AppCompatActivity {

    MyViewModel myViewModel;
    TextView textView;
    ImageButton thumbUp, thumbDown;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_live_data_test2);
        //在Activity中得到ViewModel的方法
        myViewModel = new ViewModelProvider(this, new ViewModelProvider.NewInstanceFactory()).get(MyViewModel.class);

        textView = findViewById(R.id.tv_liveData);
        thumbUp = findViewById(R.id.img_btn_thumbUp);
        thumbDown = findViewById(R.id.img_btn_thumbDown);

        //使用观察者模式实现LiveData的监听
        myViewModel.getThumbNum().observe(this, new Observer<Integer>() {
            @Override
            public void onChanged(Integer integer) {
                textView.setText(String.valueOf(integer));
            }
        });

        thumbUp.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                myViewModel.addThumb(1);
            }
        });

        thumbDown.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                myViewModel.addThumb(-1);
            }
        });

    }
}
```

activity_live_data_test2.xml：

```xml
<androidx.constraintlayout.widget.ConstraintLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context=".LiveDataTest">

    <TextView
        android:id="@+id/tv_liveData"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="@string/text_thumbNum"
        android:textSize="30sp"
        app:layout_constraintBottom_toBottomOf="parent"
        app:layout_constraintEnd_toEndOf="parent"
        app:layout_constraintHorizontal_bias="0.5"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintTop_toTopOf="parent"
        app:layout_constraintVertical_bias="0.266" />

    <ImageButton
        android:id="@+id/img_btn_thumbUp"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:contentDescription="@string/btn_thumbUp"
        app:layout_constraintBottom_toBottomOf="parent"
        app:layout_constraintEnd_toEndOf="parent"
        app:layout_constraintHorizontal_bias="0.2"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintTop_toTopOf="parent"
        app:layout_constraintVertical_bias="0.5"
        app:srcCompat="@drawable/ic_baseline_thumb_up_24" />

    <ImageButton
        android:id="@+id/img_btn_thumbDown"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:contentDescription="@string/btn_thumbDown"
        app:layout_constraintBottom_toBottomOf="parent"
        app:layout_constraintEnd_toEndOf="parent"
        app:layout_constraintHorizontal_bias="0.811"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintTop_toTopOf="parent"
        app:layout_constraintVertical_bias="0.5"
        app:srcCompat="@drawable/ic_baseline_thumb_down_24" />
</androidx.constraintlayout.widget.ConstraintLayout>
```

![image-20201119234402289](img/image-20201119234402289.png)



## P12 Data Binding

数据绑定：以声明方式将可观察数据绑定到界面元素

![image-20201119223340916](img/image-20201119223340916.png)

1. 在Modle模块下的build.gradle文件下添加数据绑定，添加完后点击sync now：

   ```gradle
   android {
   
       compileSdkVersion 30
       buildToolsVersion "30.0.1"
   
       defaultConfig {
           ...
       }
   //	  已过时
   //    dataBinding{
   //        enabled true
   //    }
   	//目前方法
       buildFeatures{
           dataBinding true
       }
   
       buildTypes {
           release {
               ...
           }
       }
       
   }
   ```

2. 在layout文件中，鼠标点击最外层的控件，使用快捷键alt+enter，选择convert to data binding layout，生成DataBingding的布局文件，这个布局文件中可以创建变量，变量相当于是在我们创建的ViewModel类中：
   可以在其中插入代码和方法，如插入代码`android:text="@{String.valueOf(data.num)}"`，调用button的onClick方法`android:onClick="@{()->data.add()}"`

   ```xml
   <?xml version="1.0" encoding="utf-8"?>
   <layout xmlns:android="http://schemas.android.com/apk/res/android"
       xmlns:app="http://schemas.android.com/apk/res-auto"
       xmlns:tools="http://schemas.android.com/tools">
   
       <data>
           <variable
               name="data"
               type="com.example.biliandroid.ViewModelWithDataBing" />
       </data>
   
       <androidx.constraintlayout.widget.ConstraintLayout
           android:layout_width="match_parent"
           android:layout_height="match_parent"
           tools:context=".DataBindingTest">
   
           <TextView
               android:id="@+id/textView"
               android:layout_width="wrap_content"
               android:layout_height="wrap_content"
               android:text="@{String.valueOf(data.num)}"
               android:textSize="30sp"
               app:layout_constraintBottom_toBottomOf="parent"
               app:layout_constraintEnd_toEndOf="parent"
               app:layout_constraintStart_toStartOf="parent"
               app:layout_constraintTop_toTopOf="parent"
               app:layout_constraintVertical_bias="0.276" />
   
           <Button
               android:id="@+id/button"
               android:layout_width="wrap_content"
               android:layout_height="wrap_content"
               android:text="@string/btn_data_bind_act"
               android:onClick="@{()->data.add()}"
               app:layout_constraintBottom_toBottomOf="parent"
               app:layout_constraintEnd_toEndOf="parent"
               app:layout_constraintStart_toStartOf="parent"
               app:layout_constraintTop_toTopOf="parent" />
       </androidx.constraintlayout.widget.ConstraintLayout>
   </layout>
   ```

   ![image-20201120090031388](img/image-20201120090031388.png)

3. 编写ViewModel类：

   ```java
   import androidx.lifecycle.MutableLiveData;
   import androidx.lifecycle.ViewModel;
   
   public class ViewModelWithDataBing extends ViewModel {
   
       /**
        * 使用LiveData创建数据
        */
       private MutableLiveData<Integer> num;
   
       public MutableLiveData<Integer> getNum() {
           //使用饿汉模式初始化
           if (num == null) {
               num = new MutableLiveData<>();
               //这里设置为0是必须的，不然没有元素，数据为null
               num.setValue(0);
           }
           return num;
       }
   
       /**
        * 一个累加器
        */
       public void add() {
           num.setValue(num.getValue() + 1);
       }
   }
   ```

4. 编写Activity类：

   ```java
   import androidx.appcompat.app.AppCompatActivity;
   import androidx.databinding.DataBindingUtil;
   import androidx.lifecycle.ViewModelProvider;
   
   import android.os.Bundle;
   
   import com.example.biliandroid.databinding.ActivityDataBindingTestBinding;
   
   public class DataBindingTest extends AppCompatActivity {
   
       ActivityDataBindingTestBinding binding;
       ViewModelWithDataBing viewModel;
   
       @Override
       protected void onCreate(Bundle savedInstanceState) {
           super.onCreate(savedInstanceState);
   //        setContentView(R.layout.activity_data_binding_test);
           //使用此方法来初始化binding对象和替代setContentView方法
           binding = DataBindingUtil.setContentView(this, R.layout.activity_data_binding_test);
           viewModel = new ViewModelProvider(this, new ViewModelProvider.NewInstanceFactory()).get(ViewModelWithDataBing.class);
   
           binding.setData(viewModel);		//此方法名根据xml中定义的变量名而变
           binding.setLifecycleOwner(this);
       }
   }
   ```



## P13 阶段练习：篮球比赛记分器

主界面：

![image-20201217231817773](img/image-20201217231817773.png)

在使用之前需要在模块的build.gradle中加入使用dataBinding的声明：

```gradle
android{
	...
	buildFeatures{
    	dataBinding true
	}
	...
}
```

xml文件（建议先修改成dataBinding之后，再创建横屏布局，可以避免重新再写一遍横屏布局的dataBinding）：

```xml
<?xml version="1.0" encoding="utf-8"?>
<layout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools">

    <data>
        <variable
            name="viewmodel"
            type="com.example.game_scorer.MyViewModel" />
    </data>

    <androidx.constraintlayout.widget.ConstraintLayout
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        tools:context=".MainActivity">

        <TextView
            android:id="@+id/textView2"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/tv_team_a"
            app:layout_constraintBottom_toTopOf="@+id/guideline3"
            app:layout_constraintEnd_toStartOf="@+id/guideline2"
            app:layout_constraintStart_toStartOf="@+id/guideline10"
            app:layout_constraintTop_toTopOf="@+id/guideline4" />

        <TextView
            android:id="@+id/tv_team_b"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/tv_team_b"
            app:layout_constraintBottom_toTopOf="@+id/guideline3"
            app:layout_constraintEnd_toStartOf="@+id/guideline11"
            app:layout_constraintStart_toStartOf="@+id/guideline2"
            app:layout_constraintTop_toTopOf="@+id/guideline4" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline2"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="vertical"
            app:layout_constraintGuide_percent="0.5" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline10"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="vertical"
            app:layout_constraintGuide_percent="0.1" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline12"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="vertical"
            app:layout_constraintGuide_percent="0.30" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline13"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="vertical"
            app:layout_constraintGuide_percent="0.7" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline11"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="vertical"
            app:layout_constraintGuide_percent="0.9" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline3"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            app:layout_constraintGuide_percent="0.15" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline5"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            app:layout_constraintGuide_percent="0.35" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline6"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            app:layout_constraintGuide_percent="0.45" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline7"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            app:layout_constraintGuide_percent="0.55" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline8"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            app:layout_constraintGuide_percent="0.65" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline14"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            app:layout_constraintGuide_percent="0.75" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline4"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            app:layout_constraintGuide_percent="0.05" />

        <TextView
            android:id="@+id/tv_team_a_score"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@{String.valueOf(viewmodel.getaScore)}"
            android:textColor="@color/teal_700"
            android:textSize="80sp"
            app:layout_constraintBottom_toTopOf="@+id/guideline5"
            app:layout_constraintEnd_toStartOf="@+id/guideline2"
            app:layout_constraintStart_toStartOf="@+id/guideline10"
            app:layout_constraintTop_toTopOf="@+id/guideline3" />

        <TextView
            android:id="@+id/tv_team_b_score"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@{String.valueOf(viewmodel.getbScore)}"
            android:textColor="@android:color/holo_red_dark"
            android:textSize="80sp"
            app:layout_constraintBottom_toTopOf="@+id/guideline5"
            app:layout_constraintEnd_toStartOf="@+id/guideline11"
            app:layout_constraintStart_toStartOf="@+id/guideline2"
            app:layout_constraintTop_toTopOf="@+id/guideline3" />

        <Button
            android:id="@+id/btn_a_1"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:background="@color/teal_700"
            android:backgroundTint="@color/teal_700"
            android:backgroundTintMode="src_over"
            android:hapticFeedbackEnabled="false"
            android:text="@string/plus_1"
            android:textSize="24sp"
            android:onClick="@{()->viewmodel.addA(1)}"
            app:layout_constraintBottom_toTopOf="@+id/guideline6"
            app:layout_constraintEnd_toStartOf="@+id/guideline2"
            app:layout_constraintStart_toStartOf="@+id/guideline10"
            app:layout_constraintTop_toTopOf="@+id/guideline5" />

        <Button
            android:id="@+id/btn_a_2"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:background="@color/teal_700"
            android:text="@string/plus_2"
            android:textSize="24sp"
            android:onClick="@{()->viewmodel.addA(2)}"
            app:layout_constraintBottom_toTopOf="@+id/guideline7"
            app:layout_constraintEnd_toStartOf="@+id/guideline2"
            app:layout_constraintStart_toStartOf="@+id/guideline10"
            app:layout_constraintTop_toTopOf="@+id/guideline6" />

        <Button
            android:id="@+id/btn_b_1"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:background="@android:color/holo_red_dark"
            android:text="@string/plus_1"
            android:textSize="24sp"
            android:onClick="@{()->viewmodel.addB(1)}"
            app:layout_constraintBottom_toTopOf="@+id/guideline6"
            app:layout_constraintEnd_toStartOf="@+id/guideline11"
            app:layout_constraintStart_toStartOf="@+id/guideline2"
            app:layout_constraintTop_toTopOf="@+id/guideline5"
            app:layout_constraintVertical_bias="0.52" />

        <Button
            android:id="@+id/btn_b_2"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:background="@android:color/holo_red_dark"
            android:text="@string/plus_2"
            android:textSize="24sp"
            android:onClick="@{()->viewmodel.addB(2)}"
            app:layout_constraintBottom_toTopOf="@+id/guideline7"
            app:layout_constraintEnd_toStartOf="@+id/guideline11"
            app:layout_constraintStart_toStartOf="@+id/guideline2"
            app:layout_constraintTop_toTopOf="@+id/guideline6" />

        <Button
            android:id="@+id/btn_a_3"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:background="@color/teal_700"
            android:text="@string/plus_3"
            android:textSize="24sp"
            android:onClick="@{()->viewmodel.addA(3)}"
            app:layout_constraintBottom_toTopOf="@+id/guideline8"
            app:layout_constraintEnd_toStartOf="@+id/guideline2"
            app:layout_constraintStart_toStartOf="@+id/guideline10"
            app:layout_constraintTop_toTopOf="@+id/guideline7" />

        <Button
            android:id="@+id/btn_b_3"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:background="@android:color/holo_red_dark"
            android:text="@string/plus_3"
            android:textSize="24sp"
            android:onClick="@{()->viewmodel.addB(3)}"
            app:layout_constraintBottom_toTopOf="@+id/guideline8"
            app:layout_constraintEnd_toStartOf="@+id/guideline11"
            app:layout_constraintStart_toStartOf="@+id/guideline2"
            app:layout_constraintTop_toTopOf="@+id/guideline7" />

        <ImageButton
            android:id="@+id/btn_replay"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:onClick="@{()->viewmodel.replay()}"
            app:layout_constraintBottom_toTopOf="@+id/guideline14"
            app:layout_constraintEnd_toStartOf="@+id/guideline2"
            app:layout_constraintStart_toStartOf="@+id/guideline12"
            app:layout_constraintTop_toTopOf="@+id/guideline8"
            app:srcCompat="@drawable/ic_baseline_reply_24"
            android:contentDescription="@string/btn_replay" />

        <ImageButton
            android:id="@+id/btn_clear"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:onClick="@{()->viewmodel.clear()}"
            app:layout_constraintBottom_toTopOf="@+id/guideline14"
            app:layout_constraintEnd_toStartOf="@+id/guideline13"
            app:layout_constraintStart_toStartOf="@+id/guideline2"
            app:layout_constraintTop_toTopOf="@+id/guideline8"
            app:srcCompat="@drawable/ic_baseline_clear_24"
            android:contentDescription="@string/btn_clear" />

    </androidx.constraintlayout.widget.ConstraintLayout>
</layout>
```

ViewModel类，实现几个功能：

```java
package com.example.game_scorer;

import androidx.lifecycle.MutableLiveData;
import androidx.lifecycle.ViewModel;

import java.util.Stack;

public class MyViewModel extends ViewModel {

    //A队的分值
    private MutableLiveData<Integer> aScore;

    //B队的分值
    private MutableLiveData<Integer> bScore;

    //两个栈用来辅助实现跳回上一步操作
    private Stack<String> teamStack = new Stack<>();     //队名栈
    private Stack<Integer> numStack = new Stack<>();     //分数栈

    public MutableLiveData<Integer> getaScore() {
        if (aScore == null) {
            aScore = new MutableLiveData<>();
            aScore.setValue(0);
        }
        return aScore;
    }

    public MutableLiveData<Integer> getbScore() {
        if (bScore == null) {
            bScore = new MutableLiveData<>();
            bScore.setValue(0);
        }
        return bScore;
    }

    public void addA(int num) {
        int temp = 0;
        if (aScore != null) {
            temp = aScore.getValue();
            aScore.setValue(temp + num);
            teamStack.push("A");
            numStack.push(num);
        }
    }

    public void addB(int num) {
        int temp = 0;
        if (bScore != null) {
            temp = bScore.getValue();
            bScore.setValue(temp + num);
            teamStack.push("B");
            numStack.push(num);
        }
    }

    public void replay() {
        if (teamStack != null && numStack != null && !teamStack.isEmpty()) {
            String team = teamStack.pop();
            int num = numStack.pop();
            if (team.equals("A")) {
                aScore.setValue(aScore.getValue() - num);
            } else if (team.equals("B")) {
                bScore.setValue(bScore.getValue() - num);
            }
        }
    }

    public void clear() {
        if (aScore != null && bScore != null) {
            aScore.setValue(0);
            bScore.setValue(0);
            //如果都为0了，则清空栈，防止退到负数
            teamStack.clear();
            numStack.clear();
        }
    }
}

```

主活动类：

```java
package com.example.game_scorer;

import androidx.appcompat.app.AppCompatActivity;
import androidx.databinding.DataBindingUtil;
import androidx.lifecycle.ViewModelProvider;

import android.os.Bundle;

import com.example.game_scorer.databinding.ActivityMainBinding;

public class MainActivity extends AppCompatActivity {

    MyViewModel viewModel;
    //此类名依托于xml文件名
    ActivityMainBinding binding;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        binding = DataBindingUtil.setContentView(this, R.layout.activity_main);
        viewModel = new ViewModelProvider(this, new ViewModelProvider.NewInstanceFactory())
                .get(MyViewModel.class);

        //此方法名依托于xml文件中的变量名
        binding.setViewmodel(viewModel);
        binding.setLifecycleOwner(this);
    }
}
```



## P14 ViewModelSavedState（即使进程在后台被杀死，数据也能活）

在一般情况下，将app置于后台，如果Android后台任务过多，该app可能会被杀死；我们可以在开发者模式下，设置为点击home键返回界面后，界面就被杀死的情况下来模拟。

![image-20201121110454550](img/image-20201121110454550.png)

如果要实现app置于后台，保证数据不会丢失，可以有新旧两种方法：

比较旧的处理方式：重写`onSaveInstanceState(Bundle)`方法；

更新的处理方式，使用ViewModelSavedState：

![image-20201121135239172](img/image-20201121135239172.png)

添加依赖：

```gradle
def lifecycle_version = "2.2.0"

implementation "androidx.lifecycle:lifecycle-viewmodel-savedstate:$lifecycle_version"
```

xml代码：

```xml
<?xml version="1.0" encoding="utf-8"?>
<layout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools">

    <data>
        <variable
            name="data"
            type="com.example.biliandroid.ViewModelRestoreViewModel" />
    </data>

    <androidx.constraintlayout.widget.ConstraintLayout
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        tools:context=".ViewModelRestore">

        <TextView
            android:id="@+id/textView"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@{String.valueOf(data.getNum())}"
            android:textSize="24sp"
            app:layout_constraintBottom_toBottomOf="parent"
            app:layout_constraintEnd_toEndOf="parent"
            app:layout_constraintStart_toStartOf="parent"
            app:layout_constraintTop_toTopOf="parent"
            app:layout_constraintVertical_bias="0.288" />

        <Button
            android:id="@+id/button"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="Button"
            android:onClick="@{()->data.add()}"
            app:layout_constraintBottom_toBottomOf="parent"
            app:layout_constraintEnd_toEndOf="parent"
            app:layout_constraintStart_toStartOf="parent"
            app:layout_constraintTop_toTopOf="parent" />
    </androidx.constraintlayout.widget.ConstraintLayout>
</layout>
```

ViewModel:

```java
import androidx.lifecycle.MutableLiveData;
import androidx.lifecycle.SavedStateHandle;
import androidx.lifecycle.ViewModel;

public class ViewModelRestoreViewModel extends ViewModel {

    private SavedStateHandle handle;

    public static final String KEY = ViewModelRestore.VM_KEY;

    public ViewModelRestoreViewModel(SavedStateHandle handle) {
        this.handle = handle;
    }

    public MutableLiveData<Integer> getNum() {
        if (!handle.contains(KEY)) {
            handle.set(KEY, 0);
        }
        return handle.getLiveData(KEY);
    }

    public void add() {
        getNum().setValue(getNum().getValue()+1);
    }
}
```

Activity:

```java
import androidx.appcompat.app.AppCompatActivity;
import androidx.databinding.DataBindingUtil;
import androidx.lifecycle.SavedStateViewModelFactory;
import androidx.lifecycle.ViewModel;
import androidx.lifecycle.ViewModelProvider;

import android.app.Application;
import android.os.Bundle;

import com.example.biliandroid.databinding.ActivityViewModelRestoreBinding;

public class ViewModelRestore extends AppCompatActivity {

    ViewModelRestoreViewModel viewModel;

    ActivityViewModelRestoreBinding binding;

    public static final String VM_KEY = "KEY";

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        binding = DataBindingUtil.setContentView(this, R.layout.activity_view_model_restore);
        viewModel = new ViewModelProvider(this, new SavedStateViewModelFactory(getApplication(), this))
                .get(ViewModelRestoreViewModel.class);
        binding.setData(viewModel);
        binding.setLifecycleOwner(this);
    }
}
```

**注意：**

- 状态必须是简单的轻量级状态。对于复杂或大型数据，您应该使用[本地持久性存储]；
- 此种方法只是运用在app在后台被杀死的情况，如果是点击back键摧毁，则仍无法恢复，若要恢复，需要使用本地持久性存储。



## P15 SharedPreferences

Android数据存储的四种方式

- **App-specific storage:** Store files that are meant for your app's use only, either in dedicated directories within an internal storage volume or different dedicated directories within external storage. Use the directories within internal storage to save sensitive information that other apps shouldn't access.
- **Shared storage:** Store files that your app intends to share with other apps, including media, documents, and other files.
- **Preferences:** Store private, primitive data in key-value pairs.
- **Databases:** Store structured data in a private database using the Room persistence library.

SharedPreferences静态构造方法有两种：

- getPreferences（int mode）：以本Activity为名创建一个文件，独有的

  ```java
  //存入内存
  //ShardPreferences shp = getPreferences(Context.MODE_PRIVATE);
  ShardPrefences shp = getShardPrefences("MY_DATA",Context.MODE_PRIVATE);
  ShardPreferences.Editor editor = shp.edit();
  editor.putInt("NUMBER",100);
  editor.apply();
  //读取
  int x = shp.getInt("NUMBER",0);	//第二为缺省值
  
  ```

  

- getShardPreferences（String name, int mode)：可以用于多Activity间的分享



如果在其他非Activity类下，调用getShardPrefences方法需要传入Context对象。

MyData：

```java
package com.example.shardpreferences;

import android.content.Context;
import android.content.SharedPreferences;

public class MyData {

    private Context context;

    public MyData(Context context) {
        this.context = context;
    }

    public void save(String data) {
        String file_name = context.getString(R.string.file_name);
        SharedPreferences shp = context.getSharedPreferences(file_name, Context.MODE_PRIVATE);
        SharedPreferences.Editor editor = shp.edit();
        String key = context.getString(R.string.key);

        editor.putString(key, data);
        editor.apply();
    }

    public String load() {
        String key = context.getString(R.string.key);
        SharedPreferences shp = context.getSharedPreferences(key, Context.MODE_PRIVATE);
        return shp.getString(key, "");
    }

}
```

Activity：

```java
package com.example.shardpreferences;

import androidx.appcompat.app.AppCompatActivity;

import android.os.Bundle;
import android.widget.Toast;

public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        //注意：这里context参数需传入这个，如果传入this的话会造成内存泄漏
        // getApplicationContext得到的context对象伴随着整个app生命周期且只有一个
        MyData data = new MyData(getApplicationContext());
        data.save("这是一条数据");
        Toast.makeText(this, data.load(), Toast.LENGTH_SHORT).show();
    }
}
```





